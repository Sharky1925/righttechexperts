<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}{{ self.page_title() }} — Admin{% endblock %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Sora:wght@500;600;700;800&display=swap"
    rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.svg') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --bg: #05080f;
      --surface: #0e1623;
      --surface-alt: #131d2d;
      --surface-glass: linear-gradient(140deg, rgba(14, 22, 35, 0.92), rgba(18, 29, 44, 0.82));
      --text: #eff7ff;
      --text-muted: #9db0c5;
      --border: rgba(104, 154, 255, 0.22);
      --accent: #74a0ff;
      --accent-strong: #4f7bff;
      --danger: #ef5f78;
      --success: #34d399;
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --gradient-vibrant: linear-gradient(135deg, #3a6dff 0%, #5f8dff 52%, #9ac4ff 100%);
      --shadow-soft: 0 16px 36px -20px rgba(0, 0, 0, 0.7);
      --shadow-lg: 0 28px 64px -30px rgba(0, 0, 0, 0.85);
      --ease: cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      color: var(--text);
      background: linear-gradient(180deg, #05080f 0%, #0a1320 48%, #0d1827 100%);
      font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-family: 'Sora', 'Manrope', sans-serif;
      letter-spacing: -0.02em;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .admin-sidebar {
      width: 268px;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      z-index: 1040;
      background: var(--surface-glass);
      border-right: 1px solid var(--border);
      backdrop-filter: blur(22px) saturate(150%);
      -webkit-backdrop-filter: blur(22px) saturate(150%);
      box-shadow: var(--shadow-soft);
      overflow-y: auto;
    }

    .admin-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 18px 18px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 1rem;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    .admin-brand-badge {
      width: 30px;
      height: 30px;
      border-radius: 9px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      background: var(--gradient-vibrant);
      box-shadow: 0 10px 22px rgba(79, 123, 255, 0.34);
      font-size: .8rem;
    }

    .sidebar-nav {
      display: grid;
      gap: 4px;
      padding: 12px 10px 18px;
    }

    .sidebar-label {
      color: #9cb4d2;
      font-size: .67rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .08em;
      padding: 8px 12px 4px;
      opacity: .85;
    }

    .sidebar-nav .nav-link {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: .86rem;
      font-weight: 600;
      color: var(--text-muted);
      border-radius: 12px;
      padding: 10px 12px;
      transition: all .2s var(--ease);
    }

    .sidebar-nav .nav-link i {
      width: 18px;
      text-align: center;
      color: #86adff;
      opacity: .95;
    }

    .sidebar-nav .nav-link:hover {
      background: rgba(79, 123, 255, 0.12);
      color: var(--text);
      transform: translateX(2px);
    }

    .sidebar-nav .nav-link.active {
      background: linear-gradient(140deg, rgba(79, 123, 255, 0.22), rgba(116, 160, 255, 0.12));
      border: 1px solid rgba(116, 160, 255, 0.34);
      color: var(--text);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .1);
    }

    .sidebar-sep {
      border-top: 1px solid var(--border);
      margin: 6px 10px;
    }

    .sidebar-collapsible {
      margin: 2px 0;
      border-radius: 12px;
    }

    .sidebar-collapsible>summary {
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
      color: var(--text-muted);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: .82rem;
      font-weight: 700;
    }

    .sidebar-collapsible>summary:hover {
      background: rgba(79, 123, 255, 0.12);
      color: var(--text);
    }

    .sidebar-collapsible>summary::-webkit-details-marker {
      display: none;
    }

    .sidebar-collapsible>summary::after {
      content: '+';
      font-size: .9rem;
      color: #9cb4d2;
      line-height: 1;
    }

    .sidebar-collapsible[open]>summary {
      background: rgba(79, 123, 255, 0.12);
      color: var(--text);
    }

    .sidebar-collapsible[open]>summary::after {
      content: '−';
    }

    .sidebar-subnav {
      display: grid;
      gap: 4px;
      padding: 4px 0 4px 10px;
    }

    .sidebar-subnav .nav-link {
      font-size: .81rem;
      padding: 8px 10px;
    }

    .mobile-admin-nav {
      display: none;
      border-bottom: 1px solid var(--border);
      background: rgba(10, 16, 27, 0.92);
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
      position: sticky;
      top: 0;
      z-index: 1030;
    }

    .mobile-admin-nav .navbar-brand {
      font-size: .95rem;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    .mobile-admin-nav .navbar-collapse {
      margin-top: 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--surface);
      padding: 10px;
    }

    .mobile-admin-nav .nav-link {
      color: var(--text-muted);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: .85rem;
      font-weight: 600;
    }

    .mobile-admin-nav .nav-link.active,
    .mobile-admin-nav .nav-link:hover {
      color: var(--text);
      background: rgba(79, 123, 255, 0.12);
    }

    .mobile-admin-nav .nav-section-label {
      color: #9fb7d4;
      font-size: .66rem;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      margin-top: 8px;
      padding: 5px 10px;
      opacity: .9;
    }

    .mobile-nav-collapsible {
      border-top: 1px solid var(--border);
      margin-top: 8px;
      padding-top: 8px;
    }

    .mobile-nav-collapsible>summary {
      list-style: none;
      cursor: pointer;
      color: #9fb7d4;
      font-size: .72rem;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      padding: 8px 10px;
      border-radius: 10px;
    }

    .mobile-nav-collapsible>summary::-webkit-details-marker {
      display: none;
    }

    .mobile-nav-collapsible>summary:hover,
    .mobile-nav-collapsible[open]>summary {
      background: rgba(79, 123, 255, 0.12);
      color: var(--text);
    }

    .mobile-nav-collapsible .nav-link {
      padding-left: 14px;
      font-size: .82rem;
    }

    .main-content {
      margin-left: 268px;
      padding: 22px;
      min-height: 100vh;
    }

    .top-bar {
      border: 1px solid var(--border);
      background: var(--surface-glass);
      border-radius: var(--radius-lg);
      padding: 14px 16px;
      margin-bottom: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
    }

    .top-bar h5 {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .user-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(79, 123, 255, 0.1);
      color: var(--text-muted);
      font-size: .74rem;
      font-weight: 700;
      letter-spacing: .02em;
      text-transform: uppercase;
    }

    .card {
      background: var(--surface-glass);
      border: 1px solid var(--border) !important;
      border-radius: var(--radius-md) !important;
      box-shadow: var(--shadow-soft) !important;
      color: var(--text);
      backdrop-filter: blur(18px) saturate(150%);
      -webkit-backdrop-filter: blur(18px) saturate(150%);
      overflow: hidden;
    }

    .card-header {
      background: rgba(79, 123, 255, 0.07) !important;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }

    .text-muted,
    .small,
    small {
      color: var(--text-muted) !important;
    }

    .btn {
      border-radius: 999px;
      font-weight: 700;
      font-size: .8rem;
      padding: 8px 14px;
    }

    .btn-sm {
      padding: 6px 11px;
      font-size: .75rem;
    }

    .btn-primary {
      border-color: rgba(172, 224, 255, 0.66);
      background: linear-gradient(132deg, #1d7fd6 0%, #36a4ff 52%, #8edaff 100%);
      box-shadow: 0 12px 26px rgba(44, 158, 255, 0.34);
      color: #fff;
    }

    .btn-primary:hover {
      color: #fff;
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(44, 158, 255, 0.42);
    }

    .btn-outline-primary {
      color: #8fb9ff;
      border-color: rgba(116, 160, 255, 0.5);
      background: rgba(79, 123, 255, 0.08);
    }

    .btn-outline-primary:hover {
      background: rgba(79, 123, 255, 0.22);
      border-color: rgba(143, 185, 255, 0.8);
      color: var(--text);
    }

    .btn-outline-secondary {
      color: var(--text-muted);
      border-color: rgba(143, 164, 196, 0.35);
      background: rgba(19, 29, 45, 0.4);
    }

    .btn-outline-secondary:hover {
      color: var(--text);
      border-color: rgba(143, 164, 196, 0.6);
      background: rgba(143, 164, 196, 0.14);
    }

    .btn-outline-danger {
      color: #ff9fb0;
      border-color: rgba(239, 95, 120, 0.52);
      background: rgba(239, 95, 120, 0.08);
    }

    .btn-outline-danger:hover {
      color: #fff;
      border-color: rgba(239, 95, 120, 0.85);
      background: rgba(239, 95, 120, 0.35);
    }

    .form-control,
    .form-select {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: rgba(5, 10, 18, 0.64);
      color: var(--text);
    }

    .form-control::placeholder {
      color: var(--text-muted);
      opacity: .75;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: rgba(99, 145, 255, 0.7);
      box-shadow: 0 0 0 3px rgba(79, 123, 255, 0.2);
      background: rgba(8, 14, 24, 0.82);
      color: var(--text);
    }

    .form-label {
      font-size: .82rem;
      font-weight: 700;
      color: #bfd2ea;
      margin-bottom: 6px;
    }

    .form-check-input {
      border-color: var(--border);
      background-color: rgba(8, 14, 24, 0.82);
    }

    .form-check-input:checked {
      background-color: var(--accent-strong);
      border-color: var(--accent-strong);
    }

    .table {
      color: var(--text);
      margin-bottom: 0;
    }

    .table> :not(caption)>*>* {
      background-color: transparent;
      border-bottom: 1px solid var(--border);
      color: inherit;
      padding: 12px 14px;
      font-size: .85rem;
      vertical-align: middle;
    }

    .table thead th {
      color: #b7c8de;
      font-size: .73rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 700;
      border-bottom: 1px solid rgba(122, 164, 232, 0.32);
    }

    .table-hover>tbody>tr:hover>* {
      background: rgba(79, 123, 255, 0.11);
      color: var(--text);
    }

    code {
      background: rgba(79, 123, 255, 0.12);
      color: #bdd2ff;
      padding: 2px 6px;
      border-radius: 8px;
    }

    .bg-light {
      background: rgba(79, 123, 255, 0.08) !important;
      color: var(--text) !important;
      border: 1px solid var(--border);
    }

    .badge {
      border-radius: 999px;
      font-size: .68rem;
      letter-spacing: .02em;
      font-weight: 700;
      padding: 6px 9px;
    }

    .bg-secondary {
      background: rgba(143, 164, 196, 0.2) !important;
      color: #d7e3f1 !important;
    }

    .bg-primary {
      background: rgba(79, 123, 255, 0.25) !important;
      color: #ddebff !important;
    }

    .bg-success {
      background: rgba(52, 211, 153, 0.25) !important;
      color: #d8ffee !important;
    }

    .bg-warning {
      background: rgba(250, 204, 21, 0.24) !important;
      color: #fff6d8 !important;
    }

    .alert {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      font-size: .88rem;
    }

    .alert-success {
      background: rgba(52, 211, 153, 0.18);
      border-color: rgba(52, 211, 153, 0.35);
      color: #d8ffee;
    }

    .alert-danger {
      background: rgba(239, 95, 120, 0.2);
      border-color: rgba(239, 95, 120, 0.4);
      color: #ffd9df;
    }

    .btn-close {
      filter: invert(1) grayscale(100%) brightness(220%);
    }

    .stat-card .card-body {
      padding: 1.25rem;
    }

    .stat-card .icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.15rem;
    }

    .media-thumb {
      height: 150px;
      object-fit: cover;
    }

    .media-thumb-placeholder {
      height: 150px;
    }

    .ticket-details-text {
      white-space: pre-line;
    }

    .logout-inline-form {
      display: contents;
    }

    .logout-nav-btn {
      border: none;
      background: none;
      cursor: pointer;
      width: 100%;
      text-align: left;
      color: inherit;
      font: inherit;
      padding: 0;
    }

    .logout-inline-block-form {
      display: inline;
    }

    .admin-card-slim {
      max-width: 560px;
      background: var(--surface);
      border: 1px solid var(--border) !important;
      border-radius: var(--radius-md) !important;
    }

    .form-control-mono-sm {
      font-size: .82rem;
    }

    .list-group-item-ghost {
      background: transparent;
      border-color: var(--border);
    }

    .admin-text-85 {
      font-size: .85rem;
    }

    @media (max-width: 991px) {
      .admin-sidebar {
        display: none;
      }

      .mobile-admin-nav {
        display: block;
      }

      .main-content {
        margin-left: 0;
        padding: 14px;
      }

      .top-bar {
        padding: 12px;
        margin-bottom: 14px;
      }

      .top-actions {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
  {% block extra_css %}{% endblock %}
</head>

<body>
  <aside class="admin-sidebar">
    <div class="admin-brand">
      <span class="admin-brand-badge"><i class="fa-solid fa-microchip"></i></span>
      <span>{{ site_settings.get('company_name', 'Right On Repair') }} Admin</span>
    </div>
    <nav class="sidebar-nav">
      <div class="sidebar-label">Essentials</div>
      {% if current_user.has_permission('dashboard:view') %}
      <a class="nav-link {% if request.endpoint == 'admin.dashboard' %}active{% endif %}"
        href="{{ url_for('admin.dashboard') }}"><i class="fa-solid fa-gauge"></i>Dashboard</a>
      <a class="nav-link {% if request.endpoint == 'admin.control_center' %}active{% endif %}"
        href="{{ url_for('admin.control_center') }}"><i class="fa-solid fa-sliders"></i>Control Center</a>
      {% endif %}
      {% if current_user.has_permission('support:manage') %}
      <a class="nav-link {% if request.endpoint in ['admin.contacts', 'admin.contact_view'] %}active{% endif %}"
        href="{{ url_for('admin.contacts') }}"><i class="fa-solid fa-envelope"></i>Contacts</a>
      <a class="nav-link {% if request.endpoint in ['admin.support_tickets', 'admin.support_ticket_view'] %}active{% endif %}"
        href="{{ url_for('admin.support_tickets') }}"><i class="fa-solid fa-ticket"></i>Support Tickets</a>
      {% endif %}
      {% if current_user.has_permission('content:manage') %}
      <a class="nav-link {% if request.endpoint in ['admin.services', 'admin.service_add', 'admin.service_edit'] %}active{% endif %}"
        href="{{ url_for('admin.services') }}"><i class="fa-solid fa-gear"></i>Services</a>
      <a class="nav-link {% if request.endpoint in ['admin.industries', 'admin.industry_add', 'admin.industry_edit'] %}active{% endif %}"
        href="{{ url_for('admin.industries') }}"><i class="fa-solid fa-building"></i>Industries</a>
      <a class="nav-link {% if request.endpoint in ['admin.posts', 'admin.post_add', 'admin.post_edit'] %}active{% endif %}"
        href="{{ url_for('admin.posts') }}"><i class="fa-solid fa-newspaper"></i>Blog Posts</a>
      <a class="nav-link {% if request.endpoint in ['admin.cms_pages', 'admin.cms_page_add', 'admin.cms_page_edit'] %}active{% endif %}"
        href="{{ url_for('admin.cms_pages') }}"><i class="fa-solid fa-file-lines"></i>CMS Pages</a>
      <a class="nav-link {% if request.endpoint in ['admin.cms_articles', 'admin.cms_article_add', 'admin.cms_article_edit'] %}active{% endif %}"
        href="{{ url_for('admin.cms_articles') }}"><i class="fa-solid fa-pen-to-square"></i>CMS Articles</a>
      <a class="nav-link {% if request.endpoint in ['admin.media', 'admin.media_upload'] %}active{% endif %}"
        href="{{ url_for('admin.media') }}"><i class="fa-solid fa-photo-film"></i>Media</a>
      {% endif %}
      {% if current_user.has_permission('settings:manage') %}
      <a class="nav-link {% if request.endpoint == 'admin.headless_hub' %}active{% endif %}"
        href="{{ url_for('admin.headless_hub') }}"><i class="fa-solid fa-cloud-arrow-down"></i>Headless CMS</a>
      <a class="nav-link {% if request.endpoint == 'admin.settings' %}active{% endif %}"
        href="{{ url_for('admin.settings') }}"><i class="fa-solid fa-sliders"></i>Settings</a>
      {% endif %}

      <div class="sidebar-sep"></div>
      <details class="sidebar-collapsible" {% if request.endpoint in [ 'admin.security_events' , 'admin.users'
        , 'admin.user_add' , 'admin.user_edit' , 'admin.team' , 'admin.team_add' , 'admin.team_edit'
        , 'admin.testimonials' , 'admin.testimonial_add' , 'admin.testimonial_edit' , 'admin.categories'
        , 'admin.category_add' , 'admin.menu_editor' , 'admin.menu_item_edit' , 'admin.content_list'
        , 'admin.content_edit' , 'admin.acp_dashboards' , 'admin.acp_dashboard_add' , 'admin.acp_dashboard_edit'
        , 'admin.acp_studio' , 'admin.acp_pages' , 'admin.acp_page_add' , 'admin.acp_page_edit'
        , 'admin.acp_sync_status' , 'admin.acp_content_types' , 'admin.acp_content_type_add'
        , 'admin.acp_content_type_edit' , 'admin.acp_content_entries' , 'admin.acp_content_entry_add'
        , 'admin.acp_content_entry_edit' , 'admin.appearance' , 'admin.acp_theme_tokens' , 'admin.acp_theme_token_add'
        , 'admin.acp_theme_token_edit' , 'admin.acp_mcp_servers' , 'admin.acp_mcp_server_add'
        , 'admin.acp_mcp_server_edit' , 'admin.acp_mcp_operations' , 'admin.acp_mcp_audit' , 'admin.acp_registry'
        , 'admin.acp_metrics' , 'admin.acp_audit' ] %}open{% endif %}>
        <summary><span><i class="fa-solid fa-toolbox me-2"></i>Advanced Tools</span></summary>
        <div class="sidebar-subnav">
          {% if current_user.has_permission('content:manage') %}
          <a class="nav-link {% if request.endpoint in ['admin.team', 'admin.team_add', 'admin.team_edit'] %}active{% endif %}"
            href="{{ url_for('admin.team') }}"><i class="fa-solid fa-users"></i>Team</a>
          <a class="nav-link {% if request.endpoint in ['admin.testimonials', 'admin.testimonial_add', 'admin.testimonial_edit'] %}active{% endif %}"
            href="{{ url_for('admin.testimonials') }}"><i class="fa-solid fa-quote-right"></i>Testimonials</a>
          <a class="nav-link {% if request.endpoint in ['admin.categories', 'admin.category_add'] %}active{% endif %}"
            href="{{ url_for('admin.categories') }}"><i class="fa-solid fa-tags"></i>Categories</a>
          <a class="nav-link {% if request.endpoint in ['admin.menu_editor', 'admin.menu_item_edit'] %}active{% endif %}"
            href="{{ url_for('admin.menu_editor') }}"><i class="fa-solid fa-bars"></i>Navigation</a>
          <a class="nav-link {% if request.endpoint in ['admin.content_list', 'admin.content_edit'] %}active{% endif %}"
            href="{{ url_for('admin.content_list') }}"><i class="fa-solid fa-file-pen"></i>Page Content</a>
          {% endif %}
          {% if current_user.has_permission('security:view') %}
          <a class="nav-link {% if request.endpoint == 'admin.security_events' %}active{% endif %}"
            href="{{ url_for('admin.security_events') }}"><i class="fa-solid fa-shield-halved"></i>Security Events</a>
          {% endif %}
          {% if current_user.has_permission('users:manage') %}
          <a class="nav-link {% if request.endpoint in ['admin.users', 'admin.user_add', 'admin.user_edit'] %}active{% endif %}"
            href="{{ url_for('admin.users') }}"><i class="fa-solid fa-user-shield"></i>Admin Users</a>
          {% endif %}
          {% if current_user.has_permission('acp:dashboards:manage') %}
          <a class="nav-link {% if request.endpoint in ['admin.acp_dashboards', 'admin.acp_dashboard_add', 'admin.acp_dashboard_edit'] %}active{% endif %}"
            href="{{ url_for('admin.acp_dashboards') }}"><i class="fa-solid fa-chart-line"></i>Dashboard Studio</a>
          {% endif %}
          {% if current_user.has_permission('acp:studio:view') %}
          <a class="nav-link {% if request.endpoint == 'admin.acp_studio' %}active{% endif %}"
            href="{{ url_for('admin.acp_studio') }}"><i class="fa-solid fa-screwdriver-wrench"></i>ACP Studio</a>
          {% endif %}
          {% if current_user.has_permission('acp:pages:manage') %}
          <a class="nav-link {% if request.endpoint in ['admin.acp_pages', 'admin.acp_page_add', 'admin.acp_page_edit'] %}active{% endif %}"
            href="{{ url_for('admin.acp_pages') }}"><i class="fa-solid fa-layer-group"></i>Visual Pages</a>
          <a class="nav-link {% if request.endpoint in ['admin.acp_sync_status'] %}active{% endif %}"
            href="{{ url_for('admin.acp_sync_status') }}"><i class="fa-solid fa-arrows-rotate"></i>Page Sync Status</a>
          {% endif %}
          {% if current_user.has_permission('acp:content:manage') %}
          <a class="nav-link {% if request.endpoint in ['admin.acp_content_types', 'admin.acp_content_type_add', 'admin.acp_content_type_edit'] %}active{% endif %}"
            href="{{ url_for('admin.acp_content_types') }}"><i class="fa-solid fa-table-list"></i>Content Types</a>
          <a class="nav-link {% if request.endpoint in ['admin.acp_content_entries', 'admin.acp_content_entry_add', 'admin.acp_content_entry_edit'] %}active{% endif %}"
            href="{{ url_for('admin.acp_content_entries') }}"><i class="fa-solid fa-file-code"></i>Content Entries</a>
          {% endif %}
          {% if current_user.has_permission('acp:theme:manage') %}
          <a class="nav-link {% if request.endpoint == 'admin.appearance' %}active{% endif %}"
            href="{{ url_for('admin.appearance') }}"><i class="fa-solid fa-paintbrush"></i>Site Appearance</a>
          <a class="nav-link {% if request.endpoint in ['admin.acp_theme_tokens', 'admin.acp_theme_token_add', 'admin.acp_theme_token_edit'] %}active{% endif %}"
            href="{{ url_for('admin.acp_theme_tokens') }}"><i class="fa-solid fa-palette"></i>Theme Tokens</a>
          {% endif %}
          {% if current_user.has_permission('acp:mcp:manage') %}
          <a class="nav-link {% if request.endpoint in ['admin.acp_mcp_servers', 'admin.acp_mcp_server_add', 'admin.acp_mcp_server_edit'] %}active{% endif %}"
            href="{{ url_for('admin.acp_mcp_servers') }}"><i class="fa-solid fa-plug-circle-bolt"></i>MCP Servers</a>
          <a class="nav-link {% if request.endpoint in ['admin.acp_mcp_operations'] %}active{% endif %}"
            href="{{ url_for('admin.acp_mcp_operations') }}"><i class="fa-solid fa-bolt"></i>MCP Operations</a>
          {% endif %}
          {% if current_user.has_permission('acp:mcp:audit:view') %}
          <a class="nav-link {% if request.endpoint == 'admin.acp_mcp_audit' %}active{% endif %}"
            href="{{ url_for('admin.acp_mcp_audit') }}"><i class="fa-solid fa-clipboard-list"></i>MCP Audit</a>
          {% endif %}
          {% if current_user.has_permission('acp:registry:manage') %}
          <a class="nav-link {% if request.endpoint == 'admin.acp_registry' %}active{% endif %}"
            href="{{ url_for('admin.acp_registry') }}"><i class="fa-solid fa-puzzle-piece"></i>Registry</a>
          {% endif %}
          {% if current_user.has_permission('acp:metrics:manage') %}
          <a class="nav-link {% if request.endpoint == 'admin.acp_metrics' %}active{% endif %}"
            href="{{ url_for('admin.acp_metrics') }}"><i class="fa-solid fa-database"></i>Metrics</a>
          {% endif %}
          {% if current_user.has_permission('acp:audit:view') %}
          <a class="nav-link {% if request.endpoint == 'admin.acp_audit' %}active{% endif %}"
            href="{{ url_for('admin.acp_audit') }}"><i class="fa-solid fa-clock-rotate-left"></i>ACP Audit</a>
          {% endif %}
        </div>
      </details>

      <div class="sidebar-sep"></div>
      <a class="nav-link" href="{{ url_for('main.index') }}" target="_blank" rel="noopener"><i
          class="fa-solid fa-up-right-from-square"></i>View Site</a>
      <form method="POST" action="{{ url_for('admin.logout') }}" class="logout-inline-form">{{ csrf_input() }}<button
          type="submit" class="nav-link logout-nav-btn"><i class="fa-solid fa-right-from-bracket"></i>Logout</button>
      </form>
    </nav>
  </aside>

  <nav class="navbar navbar-expand-lg mobile-admin-nav">
    <div class="container-fluid px-3 py-2">
      <a class="navbar-brand" href="{{ url_for('admin.dashboard') }}">{{ site_settings.get('company_name', 'Right On
        Repair') }} Admin</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminMobileNav"
        aria-controls="adminMobileNav" aria-expanded="false" aria-label="Toggle admin navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="adminMobileNav">
        <ul class="navbar-nav pt-2">
          {% if current_user.has_permission('dashboard:view') %}
          <li class="nav-item"><a class="nav-link {% if request.endpoint == 'admin.dashboard' %}active{% endif %}"
              href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link {% if request.endpoint == 'admin.control_center' %}active{% endif %}"
              href="{{ url_for('admin.control_center') }}">Control Center</a></li>
          {% endif %}
          {% if current_user.has_permission('support:manage') %}
          <li class="nav-item"><a
              class="nav-link {% if request.endpoint in ['admin.contacts', 'admin.contact_view'] %}active{% endif %}"
              href="{{ url_for('admin.contacts') }}">Contacts</a></li>
          <li class="nav-item"><a
              class="nav-link {% if request.endpoint in ['admin.support_tickets', 'admin.support_ticket_view'] %}active{% endif %}"
              href="{{ url_for('admin.support_tickets') }}">Support Tickets</a></li>
          {% endif %}
          {% if current_user.has_permission('content:manage') %}
          <li class="nav-item"><a
              class="nav-link {% if request.endpoint in ['admin.services', 'admin.service_add', 'admin.service_edit'] %}active{% endif %}"
              href="{{ url_for('admin.services') }}">Services</a></li>
          <li class="nav-item"><a
              class="nav-link {% if request.endpoint in ['admin.industries', 'admin.industry_add', 'admin.industry_edit'] %}active{% endif %}"
              href="{{ url_for('admin.industries') }}">Industries</a></li>
          <li class="nav-item"><a
              class="nav-link {% if request.endpoint in ['admin.posts', 'admin.post_add', 'admin.post_edit'] %}active{% endif %}"
              href="{{ url_for('admin.posts') }}">Blog Posts</a></li>
          <li class="nav-item"><a
              class="nav-link {% if request.endpoint in ['admin.cms_pages', 'admin.cms_page_add', 'admin.cms_page_edit'] %}active{% endif %}"
              href="{{ url_for('admin.cms_pages') }}">CMS Pages</a></li>
          <li class="nav-item"><a
              class="nav-link {% if request.endpoint in ['admin.cms_articles', 'admin.cms_article_add', 'admin.cms_article_edit'] %}active{% endif %}"
              href="{{ url_for('admin.cms_articles') }}">CMS Articles</a></li>
          <li class="nav-item"><a
              class="nav-link {% if request.endpoint in ['admin.media', 'admin.media_upload'] %}active{% endif %}"
              href="{{ url_for('admin.media') }}">Media</a></li>
          {% endif %}
          {% if current_user.has_permission('settings:manage') %}
          <li class="nav-item"><a class="nav-link {% if request.endpoint == 'admin.headless_hub' %}active{% endif %}"
              href="{{ url_for('admin.headless_hub') }}">Headless CMS</a></li>
          <li class="nav-item"><a class="nav-link {% if request.endpoint == 'admin.settings' %}active{% endif %}"
              href="{{ url_for('admin.settings') }}">Settings</a></li>
          {% endif %}
          <li class="nav-item">
            <details class="mobile-nav-collapsible" {% if request.endpoint in [ 'admin.security_events' , 'admin.users'
              , 'admin.user_add' , 'admin.user_edit' , 'admin.team' , 'admin.team_add' , 'admin.team_edit'
              , 'admin.testimonials' , 'admin.testimonial_add' , 'admin.testimonial_edit' , 'admin.categories'
              , 'admin.category_add' , 'admin.menu_editor' , 'admin.menu_item_edit' , 'admin.content_list'
              , 'admin.content_edit' , 'admin.acp_dashboards' , 'admin.acp_dashboard_add' , 'admin.acp_dashboard_edit'
              , 'admin.acp_studio' , 'admin.acp_pages' , 'admin.acp_page_add' , 'admin.acp_page_edit'
              , 'admin.acp_sync_status' , 'admin.acp_content_types' , 'admin.acp_content_type_add'
              , 'admin.acp_content_type_edit' , 'admin.acp_content_entries' , 'admin.acp_content_entry_add'
              , 'admin.acp_content_entry_edit' , 'admin.appearance' , 'admin.acp_theme_tokens'
              , 'admin.acp_theme_token_add' , 'admin.acp_theme_token_edit' , 'admin.acp_mcp_servers'
              , 'admin.acp_mcp_server_add' , 'admin.acp_mcp_server_edit' , 'admin.acp_mcp_operations'
              , 'admin.acp_mcp_audit' , 'admin.acp_registry' , 'admin.acp_metrics' , 'admin.acp_audit' ] %}open{% endif
              %}>
              <summary>Advanced Tools</summary>
              {% if current_user.has_permission('content:manage') %}
              <a class="nav-link {% if request.endpoint in ['admin.team', 'admin.team_add', 'admin.team_edit'] %}active{% endif %}"
                href="{{ url_for('admin.team') }}">Team</a>
              <a class="nav-link {% if request.endpoint in ['admin.testimonials', 'admin.testimonial_add', 'admin.testimonial_edit'] %}active{% endif %}"
                href="{{ url_for('admin.testimonials') }}">Testimonials</a>
              <a class="nav-link {% if request.endpoint in ['admin.categories', 'admin.category_add'] %}active{% endif %}"
                href="{{ url_for('admin.categories') }}">Categories</a>
              <a class="nav-link {% if request.endpoint in ['admin.menu_editor', 'admin.menu_item_edit'] %}active{% endif %}"
                href="{{ url_for('admin.menu_editor') }}">Navigation</a>
              <a class="nav-link {% if request.endpoint in ['admin.content_list', 'admin.content_edit'] %}active{% endif %}"
                href="{{ url_for('admin.content_list') }}">Page Content</a>
              {% endif %}
              {% if current_user.has_permission('security:view') %}
              <a class="nav-link {% if request.endpoint == 'admin.security_events' %}active{% endif %}"
                href="{{ url_for('admin.security_events') }}">Security Events</a>
              {% endif %}
              {% if current_user.has_permission('users:manage') %}
              <a class="nav-link {% if request.endpoint in ['admin.users', 'admin.user_add', 'admin.user_edit'] %}active{% endif %}"
                href="{{ url_for('admin.users') }}">Admin Users</a>
              {% endif %}
              {% if current_user.has_permission('acp:dashboards:manage') %}
              <a class="nav-link {% if request.endpoint in ['admin.acp_dashboards', 'admin.acp_dashboard_add', 'admin.acp_dashboard_edit'] %}active{% endif %}"
                href="{{ url_for('admin.acp_dashboards') }}">Dashboard Studio</a>
              {% endif %}
              {% if current_user.has_permission('acp:studio:view') %}
              <a class="nav-link {% if request.endpoint == 'admin.acp_studio' %}active{% endif %}"
                href="{{ url_for('admin.acp_studio') }}">ACP Studio</a>
              {% endif %}
              {% if current_user.has_permission('acp:pages:manage') %}
              <a class="nav-link {% if request.endpoint in ['admin.acp_pages', 'admin.acp_page_add', 'admin.acp_page_edit'] %}active{% endif %}"
                href="{{ url_for('admin.acp_pages') }}">Visual Pages</a>
              <a class="nav-link {% if request.endpoint in ['admin.acp_sync_status'] %}active{% endif %}"
                href="{{ url_for('admin.acp_sync_status') }}">Page Sync Status</a>
              {% endif %}
              {% if current_user.has_permission('acp:content:manage') %}
              <a class="nav-link {% if request.endpoint in ['admin.acp_content_types', 'admin.acp_content_type_add', 'admin.acp_content_type_edit'] %}active{% endif %}"
                href="{{ url_for('admin.acp_content_types') }}">Content Types</a>
              <a class="nav-link {% if request.endpoint in ['admin.acp_content_entries', 'admin.acp_content_entry_add', 'admin.acp_content_entry_edit'] %}active{% endif %}"
                href="{{ url_for('admin.acp_content_entries') }}">Content Entries</a>
              {% endif %}
              {% if current_user.has_permission('acp:theme:manage') %}
              <a class="nav-link {% if request.endpoint == 'admin.appearance' %}active{% endif %}"
                href="{{ url_for('admin.appearance') }}">Site Appearance</a>
              <a class="nav-link {% if request.endpoint in ['admin.acp_theme_tokens', 'admin.acp_theme_token_add', 'admin.acp_theme_token_edit'] %}active{% endif %}"
                href="{{ url_for('admin.acp_theme_tokens') }}">Theme Tokens</a>
              {% endif %}
              {% if current_user.has_permission('acp:mcp:manage') %}
              <a class="nav-link {% if request.endpoint in ['admin.acp_mcp_servers', 'admin.acp_mcp_server_add', 'admin.acp_mcp_server_edit'] %}active{% endif %}"
                href="{{ url_for('admin.acp_mcp_servers') }}">MCP Servers</a>
              <a class="nav-link {% if request.endpoint in ['admin.acp_mcp_operations'] %}active{% endif %}"
                href="{{ url_for('admin.acp_mcp_operations') }}">MCP Operations</a>
              {% endif %}
              {% if current_user.has_permission('acp:mcp:audit:view') %}
              <a class="nav-link {% if request.endpoint == 'admin.acp_mcp_audit' %}active{% endif %}"
                href="{{ url_for('admin.acp_mcp_audit') }}">MCP Audit</a>
              {% endif %}
              {% if current_user.has_permission('acp:registry:manage') %}
              <a class="nav-link {% if request.endpoint == 'admin.acp_registry' %}active{% endif %}"
                href="{{ url_for('admin.acp_registry') }}">Registry</a>
              {% endif %}
              {% if current_user.has_permission('acp:metrics:manage') %}
              <a class="nav-link {% if request.endpoint == 'admin.acp_metrics' %}active{% endif %}"
                href="{{ url_for('admin.acp_metrics') }}">Metrics</a>
              {% endif %}
              {% if current_user.has_permission('acp:audit:view') %}
              <a class="nav-link {% if request.endpoint == 'admin.acp_audit' %}active{% endif %}"
                href="{{ url_for('admin.acp_audit') }}">ACP Audit</a>
              {% endif %}
            </details>
          </li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.index') }}" target="_blank"
              rel="noopener">View Site</a></li>
          <li class="nav-item">
            <form method="POST" action="{{ url_for('admin.logout') }}" class="logout-inline-form">{{ csrf_input()
              }}<button type="submit" class="nav-link logout-nav-btn">Logout</button></form>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="main-content">
    <div class="top-bar">
      <h5>{% block page_title %}Dashboard{% endblock %}</h5>
      <div class="top-actions">
        <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener"><i
            class="fa-solid fa-up-right-from-square me-1"></i>View Site</a>
        <span class="user-pill">{{ current_user.username }} · {{ role_labels.get(current_user.role_key,
          current_user.role_key|title) }}</span>
        <form method="POST" action="{{ url_for('admin.logout') }}" class="logout-inline-block-form">{{ csrf_input()
          }}<button type="submit" class="btn btn-sm btn-outline-danger"><i
              class="fa-solid fa-right-from-bracket me-1"></i>Logout</button></form>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <!-- Command Palette Modal -->
  <div class="modal fade" id="commandPalette" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content"
        style="background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg);">
        <div class="modal-body p-3">
          <input type="search" class="form-control mb-2" id="cmdSearch" placeholder="Search or jump to..."
            autocomplete="off" autofocus>
          <div id="cmdResults" style="max-height: 320px; overflow-y: auto;"></div>
          <div class="d-flex flex-wrap gap-1 mt-2" id="cmdQuickActions">
            <a href="{{ url_for('admin.post_add') }}" class="btn btn-sm btn-outline-secondary">New Post</a>
            <a href="{{ url_for('admin.service_add') }}" class="btn btn-sm btn-outline-secondary">New Service</a>
            <a href="{{ url_for('admin.industry_add') }}" class="btn btn-sm btn-outline-secondary">New Industry</a>
            <a href="{{ url_for('admin.headless_hub') }}" class="btn btn-sm btn-outline-secondary">Headless Hub</a>
            <a href="{{ url_for('admin.settings') }}" class="btn btn-sm btn-outline-secondary">Settings</a>
            <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-outline-secondary" target="_blank"
              rel="noopener">View Site</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script nonce="{{ csp_nonce }}"
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script nonce="{{ csp_nonce }}">
    document.querySelectorAll('form.confirm-delete').forEach(function (f) {
      f.addEventListener('submit', function (e) {
        if (!confirm('Are you sure you want to delete this item?')) e.preventDefault();
      });
    });
    // Command palette (Cmd+K / Ctrl+K)
    (function () {
      var palette = document.getElementById('commandPalette');
      var searchInput = document.getElementById('cmdSearch');
      var resultsDiv = document.getElementById('cmdResults');
      var openBtn = document.getElementById('openCmdPalette');
      if (!palette || !searchInput || !resultsDiv) return;
      var bsModal = null;
      function getModal() {
        if (!bsModal) bsModal = new bootstrap.Modal(palette);
        return bsModal;
      }
      function openPalette() {
        getModal().show();
        setTimeout(function () { searchInput.focus(); searchInput.select(); }, 150);
      }
      if (openBtn) openBtn.addEventListener('click', openPalette);
      document.addEventListener('keydown', function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          openPalette();
        }
      });
      var debounceTimer;
      searchInput.addEventListener('input', function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(doSearch, 300);
      });
      function doSearch() {
        var q = searchInput.value.trim();
        if (q.length < 2) { resultsDiv.innerHTML = ''; return; }
        resultsDiv.innerHTML = '<div class="text-muted small text-center py-2">Searching...</div>';
        fetch('{{ url_for("admin.admin_search_api") }}?q=' + encodeURIComponent(q))
          .then(function (r) {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
          })
          .then(function (data) {
            var html = '';
            (data.results || []).forEach(function (item) {
              html += '<a href="' + item.url + '" class="d-block p-2 rounded mb-1 text-decoration-none" style="border:1px solid var(--border);background:rgba(7,13,23,.6);">';
              html += '<strong style="font-size:.82rem;">' + item.title + '</strong>';
              html += '<span class="d-block text-muted" style="font-size:.72rem;">' + item.type + (item.status ? ' · ' + item.status : '') + '</span>';
              html += '</a>';
            });
            if (!html) html = '<div class="text-muted small text-center py-2">No results found</div>';
            resultsDiv.innerHTML = html;
          })
          .catch(function (err) {
            console.error('Command palette search error:', err);
            resultsDiv.innerHTML = '<div class="text-muted small text-center py-2">Search failed — please try again</div>';
          });
      }
    })();
  </script>
  {% block extra_js %}{% endblock %}
</body>

</html>