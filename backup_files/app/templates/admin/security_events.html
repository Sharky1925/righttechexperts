{% extends "admin/base.html" %}
{% block page_title %}Security Events{% endblock %}
{% block content %}
<div class="row g-3 mb-3">
  <div class="col-md-4 col-sm-6">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="icon bg-primary bg-opacity-10 text-primary me-3"><i class="fa-solid fa-shield"></i></div>
        <div><div class="fw-bold fs-4">{{ stats.last_24h }}</div><div class="text-muted small">Events (24h)</div></div>
      </div>
    </div>
  </div>
  <div class="col-md-4 col-sm-6">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="icon bg-warning bg-opacity-10 text-warning me-3"><i class="fa-solid fa-robot"></i></div>
        <div><div class="fw-bold fs-4">{{ stats.turnstile_failed_24h }}</div><div class="text-muted small">Turnstile Failed (24h)</div></div>
      </div>
    </div>
  </div>
  <div class="col-md-4 col-sm-6">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="icon bg-danger bg-opacity-10 text-danger me-3"><i class="fa-solid fa-gauge-high"></i></div>
        <div><div class="fw-bold fs-4">{{ stats.rate_limited_24h }}</div><div class="text-muted small">Rate Limited (24h)</div></div>
      </div>
    </div>
  </div>
</div>

<div class="card border-0 shadow-sm mb-3">
  <div class="card-body">
    <form method="GET" action="{{ url_for('admin.security_events') }}" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label mb-1">Event Type</label>
        <select class="form-select" name="event_type">
          <option value="all" {% if event_type_filter == 'all' %}selected{% endif %}>All</option>
          <option value="turnstile_failed" {% if event_type_filter == 'turnstile_failed' %}selected{% endif %}>Turnstile Failed</option>
          <option value="rate_limited" {% if event_type_filter == 'rate_limited' %}selected{% endif %}>Rate Limited</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label mb-1">Scope</label>
        <select class="form-select" name="scope">
          <option value="all" {% if scope_filter == 'all' %}selected{% endif %}>All</option>
          <option value="contact_form" {% if scope_filter == 'contact_form' %}selected{% endif %}>Contact Form</option>
          <option value="quote_form" {% if scope_filter == 'quote_form' %}selected{% endif %}>Quote Form</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label mb-1">Search (IP / Path / Details)</label>
        <input type="text" class="form-control" name="q" value="{{ search }}" placeholder="127.0.0.1 or turnstile">
      </div>
      <div class="col-md-2 d-flex gap-2">
        <button class="btn btn-primary w-100" type="submit">Apply</button>
        <a href="{{ url_for('admin.security_events') }}" class="btn btn-outline-secondary">Reset</a>
      </div>
    </form>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-body p-0">
    <table class="table table-hover mb-0">
      <thead>
        <tr>
          <th>Time (UTC)</th>
          <th>Type</th>
          <th>Scope</th>
          <th>IP</th>
          <th>Path</th>
          <th>Method</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items.items %}
        <tr>
          <td>{{ item.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
          <td>
            {% if item.event_type == 'turnstile_failed' %}
            <span class="badge bg-warning text-dark">turnstile_failed</span>
            {% else %}
            <span class="badge bg-danger">rate_limited</span>
            {% endif %}
          </td>
          <td><code>{{ item.scope }}</code></td>
          <td><code>{{ item.ip }}</code></td>
          <td><code>{{ item.path }}</code></td>
          <td>{{ item.method }}</td>
          <td>{{ item.details or '-' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="text-center text-muted py-3">No security events found for current filters</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if items.pages > 1 %}
<nav aria-label="Security events pagination" class="mt-3">
  <ul class="pagination pagination-sm">
    <li class="page-item {% if not items.has_prev %}disabled{% endif %}">
      {% if items.has_prev %}
      <a class="page-link" href="{{ url_for('admin.security_events', page=items.prev_num, event_type=event_type_filter, scope=scope_filter, q=search) }}">Previous</a>
      {% else %}
      <span class="page-link">Previous</span>
      {% endif %}
    </li>
    <li class="page-item disabled"><span class="page-link">Page {{ items.page }} / {{ items.pages }}</span></li>
    <li class="page-item {% if not items.has_next %}disabled{% endif %}">
      {% if items.has_next %}
      <a class="page-link" href="{{ url_for('admin.security_events', page=items.next_num, event_type=event_type_filter, scope=scope_filter, q=search) }}">Next</a>
      {% else %}
      <span class="page-link">Next</span>
      {% endif %}
    </li>
  </ul>
</nav>
{% endif %}
{% endblock %}
